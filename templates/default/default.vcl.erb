backend default {
  .host = "<%= node['varnish']['backend_host'] %>";
  .port = "<%= node['varnish']['backend_port'] %>";
}

acl internal_nrel {
  "localhost";













}

sub vcl_recv {
  # Remove all stats cookies:
  #
  # - Google Analytic cookies named __utm* (utma, utmb, etc)
  # - Crazy Egg "is_returning" cookie
  set req.http.Cookie = regsuball(req.http.Cookie, "(^|; ) *(__utm.|is_returning)=[^;]+;? *", "\1");

  # Remove the cookie if it's now empty, so simple stats cookies don't prevent caching.
  if(req.http.Cookie == "") {
    remove req.http.Cookie;
  }

  # Remove the cookie for all static files, so they can always be returned from
  # the cache, even if the user has other cookies set.
  if(req.url ~ "\.(html|js|css|png|gif|jpg|jpeg)$") {
    remove req.http.Cookie;
  }

  # Allow internal connections to force cache misses for testing/debug
  # purposes.
  if (req.http.Cache-Control ~ "no-cache" && client.ip ~ internal_nrel) {
    set req.hash_always_miss = true;
  }
}
